
> @escapehatch/control-plane@0.1.0 test /home/desmond/Documents/EscapeHatch/EscapeHatch/apps/control-plane
> npx dotenv-cli -e ../../.env -- tsx --test src/test/*.test.ts "src/test/integration-auth-chat-permissions.test.ts"

TAP version 13
# --- Configuration Loaded ---
# Port: 4000
# Dev Auth Bypass: true
# Discord OIDC Enabled: true
# Google OIDC Enabled: true
# Twitch OIDC Enabled: true
# Discord Bridge Credentials: true
# Discord Bot Token Present: true
# ----------------------------
# {"at":"2026-02-26T20:08:33.531Z","level":"info","message":"request_completed","requestId":"req-1","method":"GET","route":"/auth/session/me","statusCode":401}
# Subtest: auth/session returns structured unauthorized error with correlation id
ok 1 - auth/session returns structured unauthorized error with correlation id
  ---
  duration_ms: 143.914653
  ...
# {"at":"2026-02-26T20:08:33.574Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":401}
# Subtest: bootstrap-admin returns unauthorized before bootstrap checks when session is missing
ok 2 - bootstrap-admin returns unauthorized before bootstrap checks when session is missing
  ---
  duration_ms: 40.42889
  ...
# {"at":"2026-02-26T20:08:33.636Z","level":"info","message":"request_completed","requestId":"req-1","method":"GET","route":"/v1/channels/:channelId/messages","statusCode":401}
# {"at":"2026-02-26T20:08:33.638Z","level":"info","message":"request_completed","requestId":"req-2","method":"GET","route":"/v1/permissions","statusCode":401}
# Subtest: chat and permissions routes return unauthorized before initialization checks without session
ok 3 - chat and permissions routes return unauthorized before initialization checks without session
  ---
  duration_ms: 63.26763
  ...
# {"at":"2026-02-26T20:08:33.686Z","level":"error","message":"Request validation failed.","requestId":"req-1","method":"GET","route":"/auth/login/:provider","statusCode":400,"code":"validation_error"}
# {"at":"2026-02-26T20:08:33.687Z","level":"info","message":"request_completed","requestId":"req-1","method":"GET","route":"/auth/login/:provider","statusCode":400}
# Subtest: invalid provider on auth login returns structured validation error
ok 4 - invalid provider on auth login returns structured validation error
  ---
  duration_ms: 48.409595
  ...
# {"at":"2026-02-26T20:08:33.814Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:33.839Z","level":"info","message":"request_completed","requestId":"req-2","method":"GET","route":"/auth/session/me","statusCode":200}
# {"at":"2026-02-26T20:08:33.848Z","level":"info","message":"request_completed","requestId":"req-3","method":"GET","route":"/v1/bootstrap/context","statusCode":200}
# {"at":"2026-02-26T20:08:33.860Z","level":"info","message":"request_completed","requestId":"req-4","method":"GET","route":"/v1/permissions","statusCode":200}
# {"at":"2026-02-26T20:08:33.883Z","level":"error","message":"Forbidden: action is outside of assigned moderation scope.","requestId":"req-5","method":"PATCH","route":"/v1/channels/:channelId/controls","statusCode":403,"code":"forbidden_scope"}
# {"at":"2026-02-26T20:08:33.884Z","level":"info","message":"request_completed","requestId":"req-5","method":"PATCH","route":"/v1/channels/:channelId/controls","statusCode":403}
# Subtest: authenticated bootstrap + provisioning context + permission gate flow
ok 5 - authenticated bootstrap + provisioning context + permission gate flow
  ---
  duration_ms: 197.408519
  ...
# {"at":"2026-02-26T20:08:33.935Z","level":"info","message":"request_completed","requestId":"req-1","method":"GET","route":"/auth/dev-login","statusCode":302}
# {"at":"2026-02-26T20:08:33.947Z","level":"info","message":"request_completed","requestId":"req-2","method":"GET","route":"/auth/session/me","statusCode":200}
# Subtest: dev login establishes session when bypass is enabled
ok 6 - dev login establishes session when bypass is enabled
  ---
  duration_ms: 62.366685
  ...
# {"at":"2026-02-26T20:08:33.997Z","level":"info","message":"request_completed","requestId":"req-1","method":"GET","route":"/auth/session/me","statusCode":200}
# Subtest: session includes linked identities for same product user
ok 7 - session includes linked identities for same product user
  ---
  duration_ms: 50.490836
  ...
# {"at":"2026-02-26T20:08:34.060Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/onboarding/username","statusCode":409}
# {"at":"2026-02-26T20:08:34.065Z","level":"info","message":"request_completed","requestId":"req-2","method":"POST","route":"/auth/onboarding/username","statusCode":204}
# {"at":"2026-02-26T20:08:34.072Z","level":"info","message":"request_completed","requestId":"req-3","method":"GET","route":"/auth/session/me","statusCode":200}
# Subtest: onboarding username assignment updates linked identities and enforces uniqueness
ok 8 - onboarding username assignment updates linked identities and enforces uniqueness
  ---
  duration_ms: 74.198279
  ...
# Subtest: federation allowlist matching handles allowed vs denied homeservers
ok 9 - federation allowlist matching handles allowed vs denied homeservers
  ---
  duration_ms: 0.939693
  ...
# {"at":"2026-02-26T20:08:34.144Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:34.149Z","level":"info","message":"request_completed","requestId":"req-2","method":"GET","route":"/v1/bootstrap/context","statusCode":200}
# {"at":"2026-02-26T20:08:34.163Z","level":"info","message":"request_completed","requestId":"req-3","method":"PUT","route":"/v1/hubs/:hubId/federation-policy","statusCode":200}
# {"at":"2026-02-26T20:08:34.174Z","level":"info","message":"request_completed","requestId":"req-4","method":"POST","route":"/v1/hubs/:hubId/federation-policy/reconcile","statusCode":200}
# Synapse request network failure: fetch failed; continuing without Synapse provisioning.
# {"at":"2026-02-26T20:08:34.204Z","level":"info","message":"request_completed","requestId":"req-5","method":"POST","route":"/v1/channels","statusCode":201}
# {"at":"2026-02-26T20:08:34.215Z","level":"info","message":"request_completed","requestId":"req-6","method":"PATCH","route":"/v1/channels/:channelId/video-controls","statusCode":200}
# {"at":"2026-02-26T20:08:34.224Z","level":"info","message":"request_completed","requestId":"req-7","method":"GET","route":"/v1/discord/oauth/start","statusCode":302}
# {"at":"2026-02-26T20:08:34.434Z","level":"error","message":"Discord bridge token exchange failed (400).","requestId":"req-8","method":"GET","route":"/v1/discord/oauth/callback","statusCode":500,"code":"internal_error"}
# {"at":"2026-02-26T20:08:34.434Z","level":"info","message":"request_completed","requestId":"req-8","method":"GET","route":"/v1/discord/oauth/callback","statusCode":500}
# Subtest: federation + discord bridge + video controls admin workflow
not ok 10 - federation + discord bridge + video controls admin workflow
  ---
  duration_ms: 375.296636
  location: '/home/desmond/Documents/EscapeHatch/EscapeHatch/apps/control-plane/src/test/integration-auth-chat-permissions.test.ts:1:10500'
  failureType: 'testCodeFailure'
  error: |-
    Expected values to be strictly equal:
    
    500 !== 302
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 302
  actual: 500
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (/home/desmond/Documents/EscapeHatch/EscapeHatch/apps/control-plane/src/test/integration-auth-chat-permissions.test.ts:508:12)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# {"at":"2026-02-26T20:08:34.507Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:34.525Z","level":"error","message":"Forbidden: role grant outside assigned management scope.","requestId":"req-2","method":"POST","route":"/v1/roles/grant","statusCode":403,"code":"forbidden_scope"}
# {"at":"2026-02-26T20:08:34.526Z","level":"info","message":"request_completed","requestId":"req-2","method":"POST","route":"/v1/roles/grant","statusCode":403}
# {"at":"2026-02-26T20:08:34.542Z","level":"info","message":"request_completed","requestId":"req-3","method":"POST","route":"/v1/roles/grant","statusCode":204}
# {"at":"2026-02-26T20:08:34.550Z","level":"error","message":"Hub Administrator grants must target hub scope only.","requestId":"req-4","method":"POST","route":"/v1/roles/grant","statusCode":409,"code":"role_escalation_denied"}
# {"at":"2026-02-26T20:08:34.550Z","level":"info","message":"request_completed","requestId":"req-4","method":"POST","route":"/v1/roles/grant","statusCode":409}
# Subtest: role grants are scope-gated and prevent escalation
ok 11 - role grants are scope-gated and prevent escalation
  ---
  duration_ms: 101.65404
  ...
# {"at":"2026-02-26T20:08:34.632Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:34.647Z","level":"info","message":"request_completed","requestId":"req-2","method":"POST","route":"/v1/servers/:serverId/delegation/space-owners","statusCode":201}
# Synapse request network failure: fetch failed; continuing without Synapse provisioning.
# {"at":"2026-02-26T20:08:34.659Z","level":"info","message":"request_completed","requestId":"req-3","method":"POST","route":"/v1/channels","statusCode":201}
# {"at":"2026-02-26T20:08:34.665Z","level":"info","message":"request_completed","requestId":"req-4","method":"GET","route":"/v1/servers/:serverId/delegation/space-owners","statusCode":200}
# {"at":"2026-02-26T20:08:34.668Z","level":"info","message":"request_completed","requestId":"req-5","method":"GET","route":"/v1/bootstrap/context","statusCode":200}
# {"at":"2026-02-26T20:08:34.685Z","level":"info","message":"request_completed","requestId":"req-6","method":"GET","route":"/v1/hubs/:hubId/delegation/audit-events","statusCode":200}
# {"at":"2026-02-26T20:08:34.698Z","level":"info","message":"request_completed","requestId":"req-7","method":"DELETE","route":"/v1/delegation/space-owners/:assignmentId","statusCode":204}
# {"at":"2026-02-26T20:08:34.711Z","level":"info","message":"request_completed","requestId":"req-8","method":"POST","route":"/v1/channels","statusCode":403}
# Subtest: space owner assignment lifecycle grants and revokes scoped management
ok 12 - space owner assignment lifecycle grants and revokes scoped management
  ---
  duration_ms: 160.91697
  ...
# {"at":"2026-02-26T20:08:34.765Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:34.783Z","level":"info","message":"request_completed","requestId":"req-2","method":"POST","route":"/v1/servers/:serverId/delegation/space-owners","statusCode":201}
# {"at":"2026-02-26T20:08:34.795Z","level":"info","message":"request_completed","requestId":"req-3","method":"POST","route":"/v1/channels","statusCode":403}
# Subtest: expired space owner assignments no longer grant management scope
ok 13 - expired space owner assignments no longer grant management scope
  ---
  duration_ms: 83.353144
  ...
# {"at":"2026-02-26T20:08:34.852Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:34.868Z","level":"info","message":"request_completed","requestId":"req-2","method":"POST","route":"/v1/servers/:serverId/delegation/ownership/transfer","statusCode":200}
# Synapse request network failure: fetch failed; continuing without Synapse provisioning.
# {"at":"2026-02-26T20:08:34.883Z","level":"info","message":"request_completed","requestId":"req-3","method":"POST","route":"/v1/channels","statusCode":201}
# Subtest: space ownership transfer updates effective management owner
ok 14 - space ownership transfer updates effective management owner
  ---
  duration_ms: 88.336315
  ...
# {"at":"2026-02-26T20:08:34.941Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# Synapse request network failure: fetch failed; continuing without Synapse provisioning.
# {"at":"2026-02-26T20:08:34.956Z","level":"info","message":"request_completed","requestId":"req-2","method":"POST","route":"/v1/channels","statusCode":201}
# {"at":"2026-02-26T20:08:34.963Z","level":"info","message":"request_completed","requestId":"req-3","method":"POST","route":"/v1/roles/grant","statusCode":204}
# {"at":"2026-02-26T20:08:35.455Z","level":"info","message":"request_completed","requestId":"req-4","method":"POST","route":"/v1/channels/:channelId/messages","statusCode":201}
# {"at":"2026-02-26T20:08:35.458Z","level":"info","message":"request_completed","requestId":"req-5","method":"GET","route":"/v1/channels/:channelId/mentions","statusCode":200}
# {"at":"2026-02-26T20:08:35.462Z","level":"info","message":"request_completed","requestId":"req-6","method":"PUT","route":"/v1/channels/:channelId/read-state","statusCode":200}
# {"at":"2026-02-26T20:08:35.465Z","level":"info","message":"request_completed","requestId":"req-7","method":"GET","route":"/v1/channels/:channelId/mentions","statusCode":200}
# {"at":"2026-02-26T20:08:35.470Z","level":"info","message":"request_completed","requestId":"req-8","method":"POST","route":"/v1/voice/token","statusCode":200}
# {"at":"2026-02-26T20:08:35.478Z","level":"info","message":"request_completed","requestId":"req-9","method":"POST","route":"/v1/voice/presence/join","statusCode":204}
# {"at":"2026-02-26T20:08:35.484Z","level":"info","message":"request_completed","requestId":"req-a","method":"PATCH","route":"/v1/voice/presence/state","statusCode":204}
# {"at":"2026-02-26T20:08:35.488Z","level":"info","message":"request_completed","requestId":"req-b","method":"GET","route":"/v1/voice/presence","statusCode":200}
# {"at":"2026-02-26T20:08:35.499Z","level":"info","message":"request_completed","requestId":"req-c","method":"POST","route":"/v1/voice/presence/leave","statusCode":204}
# Subtest: read-state mention markers and voice presence flows work for scoped users
ok 15 - read-state mention markers and voice presence flows work for scoped users
  ---
  duration_ms: 616.165301
  ...
# {"at":"2026-02-26T20:08:35.540Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:35.548Z","level":"info","message":"request_completed","requestId":"req-2","method":"POST","route":"/v1/servers/:serverId/delegation/space-owners","statusCode":201}
# {"at":"2026-02-26T20:08:35.561Z","level":"info","message":"request_completed","requestId":"req-3","method":"PATCH","route":"/v1/servers/:serverId","statusCode":200}
# {"at":"2026-02-26T20:08:35.571Z","level":"info","message":"request_completed","requestId":"req-4","method":"POST","route":"/v1/categories","statusCode":201}
# {"at":"2026-02-26T20:08:35.582Z","level":"info","message":"request_completed","requestId":"req-5","method":"DELETE","route":"/v1/categories/:categoryId","statusCode":204}
# {"at":"2026-02-26T20:08:35.589Z","level":"info","message":"request_completed","requestId":"req-6","method":"GET","route":"/v1/me/roles","statusCode":200}
# Subtest: space owner can rename their own space and manage categories
ok 16 - space owner can rename their own space and manage categories
  ---
  duration_ms: 89.36084
  ...
# {"at":"2026-02-26T20:08:35.643Z","level":"info","message":"request_completed","requestId":"req-1","method":"POST","route":"/auth/bootstrap-admin","statusCode":201}
# {"at":"2026-02-26T20:08:35.646Z","level":"info","message":"request_completed","requestId":"req-2","method":"GET","route":"/v1/bootstrap/context","statusCode":200}
# {"at":"2026-02-26T20:08:35.659Z","level":"info","message":"request_completed","requestId":"req-3","method":"POST","route":"/v1/servers/:serverId/delegation/space-owners","statusCode":201}
# {"at":"2026-02-26T20:08:35.672Z","level":"info","message":"request_completed","requestId":"req-4","method":"GET","route":"/v1/discord/oauth/start","statusCode":302}
# {"at":"2026-02-26T20:08:35.682Z","level":"info","message":"request_completed","requestId":"req-5","method":"PATCH","route":"/v1/hubs/:hubId/settings","statusCode":204}
# {"at":"2026-02-26T20:08:35.689Z","level":"info","message":"request_completed","requestId":"req-6","method":"GET","route":"/v1/discord/oauth/start","statusCode":403}
# {"at":"2026-02-26T20:08:35.699Z","level":"info","message":"request_completed","requestId":"req-7","method":"GET","route":"/v1/discord/oauth/start","statusCode":302}
# Subtest: Discord bridge permissions respect Hub setting for Space Owners
ok 17 - Discord bridge permissions respect Hub setting for Space Owners
  ---
  duration_ms: 109.957322
  ...
# --- Configuration Loaded ---
# Port: 4000
# Dev Auth Bypass: true
# Discord OIDC Enabled: true
# Google OIDC Enabled: true
# Twitch OIDC Enabled: true
# Discord Bridge Credentials: true
# Discord Bot Token Present: true
# ----------------------------
# Subtest: space moderator can ban users within scope
ok 18 - space moderator can ban users within scope
  ---
  duration_ms: 2.050184
  ...
# Subtest: cross-scope moderation is rejected
ok 19 - cross-scope moderation is rejected
  ---
  duration_ms: 0.430738
  ...
# --- Configuration Loaded ---
# Port: 4000
# Dev Auth Bypass: true
# Discord OIDC Enabled: true
# Google OIDC Enabled: true
# Twitch OIDC Enabled: true
# Discord Bridge Credentials: true
# Discord Bot Token Present: true
# ----------------------------
# {"at":"2026-02-26T20:08:33.536Z","level":"info","message":"request_completed","requestId":"req-1","method":"GET","route":"/health","statusCode":200}
# Subtest: health endpoint returns ok
ok 20 - health endpoint returns ok
  ---
  duration_ms: 142.118092
  ...
# {"at":"2026-02-26T20:08:33.571Z","level":"info","message":"request_completed","requestId":"req-1","method":"GET","route":"/auth/providers","statusCode":200}
# Subtest: providers endpoint exposes discord as primary
not ok 21 - providers endpoint exposes discord as primary
  ---
  duration_ms: 39.284669
  location: '/home/desmond/Documents/EscapeHatch/EscapeHatch/apps/control-plane/src/test/smoke.test.ts:1:363'
  failureType: 'testCodeFailure'
  error: |-
    Expected values to be strictly equal:
    + actual - expected
    
    + 'dev'
    - 'discord'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 'discord'
  actual: 'dev'
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (/home/desmond/Documents/EscapeHatch/EscapeHatch/apps/control-plane/src/test/smoke.test.ts:18:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
1..21
# tests 21
# suites 0
# pass 19
# fail 2
# cancelled 0
# skipped 0
# todo 0
# duration_ms 13316.508598
 ELIFECYCLE  Test failed. See above for more details.
